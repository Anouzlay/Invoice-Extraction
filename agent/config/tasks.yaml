extract_vendor_basic_info_task:
  description: >
    Extract vendor information and basic invoice details from the invoice PDF.
    
    The PDF file path to process is: {pdf_path}
    
    EXECUTION STEPS (follow in order):
    
    STEP 1: Extract PDF text
    - Call pdf_extractor_fitz tool ONCE with the path: {pdf_path}
    - Save the returned text for all subsequent analysis
    
    STEP 2: Extract vendor name (TEXT ANALYSIS ONLY - NO TOOL CALLS)
    - **CRITICAL: This step is TEXT ANALYSIS ONLY. Do NOT call any tools. Do NOT use "vendor_name_extracted" as a tool name - it does not exist.**
    - From the PDF text (from Step 1), identify the VENDOR NAME (the invoice issuer, NOT the buyer)
    - **CRITICAL: The extracted text from Step 1 is a unified text layer containing:**
      * Regular PDF text (for invoice details)
      * OCR text extracted from embedded images (e.g., vendor logos)
    - **CRITICAL: All text is combined into one unified layer - search through the entire text for vendor names.**
    - **CRITICAL: Vendor names can appear anywhere in the unified text - in regular text OR from OCR of images/logos.**
    - **CRITICAL: The vendor is the company/organization that ISSUED the invoice. Look for:**
      * Company names in the header/top section of the invoice
      * Names in logos/images (extracted via OCR and included in the unified text)
      * Names associated with "Rechnung" (invoice), "Facture" (invoice), "Fattura" (invoice)
      * Names in the "From" or "Issuer" section
      * Government agencies, organizations, or companies that are NOT "Sigvaris AG"
      * Examples: "Bundesamt für Zoll und Grenzsicherheit BAZG", "Eidgenössisches Finanzdepartement EFD", "DACHSER", etc.
    - CRITICAL EXCLUSION RULE: NEVER extract "Sigvaris AG" as vendor name (case-insensitive: "SIGVARIS AG", "Sigvaris AG", "sigvaris ag", etc.)
      * "Sigvaris AG" is the buyer/company requesting this project, NOT the vendor
      * If you find "Sigvaris AG" (in any case variation), SKIP IT and look for a different vendor name
      * This exclusion applies to ALL case variations: "SIGVARIS AG", "Sigvaris AG", "sigvaris ag", "SIGVARIS ag", etc.
      * If "Sigvaris AG" is the only company name found, return null for vendor_name_extracted (do NOT extract it)
    - Extract the raw vendor name as it appears in the PDF (but NEVER "Sigvaris AG" in any case)
    - **SAVE this extracted vendor name in memory - you will use it in Step 3**
    - **CRITICAL: If you extracted a vendor name (not null), you MUST proceed to Step 3. If vendor name is null, you MUST still proceed to Step 3 (the tool will handle null gracefully).**
    
    STEP 3: Lookup vendor in master (MANDATORY TOOL CALL - MUST BE EXECUTED)
    - **CRITICAL: This is a MANDATORY tool call. You MUST call vendor_master_lookup tool.**
    - **CRITICAL: This is your FIRST tool call after Step 1. Use ONLY the tool: vendor_master_lookup**
    - **CRITICAL: There is NO tool called "vendor_name_extracted" - that is a JSON field name, NOT a tool name**
    - **CRITICAL: You MUST call this tool. Do NOT skip this step. Do NOT proceed to Step 4 without calling this tool.**
    - **CRITICAL: You MUST call this tool even if vendor_name from Step 2 is null or empty.**
    - Call vendor_master_lookup tool ONCE with the extracted vendor name from Step 2
    - Use the format: Action: vendor_master_lookup, Action Input: {{"vendor_name": "extracted name here"}}
    - **If vendor_name from Step 2 is null or empty, call the tool with an empty string "" - the tool will return null results which is acceptable**
    - Save vendor_number and matched_vendor_name from the result
    - **CRITICAL: After calling this tool, you MUST proceed to Step 4. Do NOT skip to other steps.**
    
    STEP 4: Lookup cost category (CONDITIONAL TOOL CALL)
    - **CRITICAL: Check the vendor_number from Step 3. If vendor_number is NOT null, you MUST call cost_category_lookup tool.**
    - **CRITICAL: If vendor_number was found in Step 3 (not null), you MUST call cost_category_lookup tool ONCE with the vendor_number**
    - **CRITICAL: Do NOT skip this step if vendor_number is not null. You MUST call the tool.**
    - Call cost_category_lookup tool ONCE with the vendor_number from Step 3
    - Use the format: Action: cost_category_lookup, Action Input: {{"vendor_number": "vendor number here"}}
    - Save cost_category from the result (this is the Cost Category value)
    - If vendor_number is null, skip calling the tool and set cost_category to null
    - **CRITICAL: After completing cost_category_lookup, you have finished ALL tool calls for Steps 1-4.**
    - **CRITICAL: Now you MUST do Steps 5-7 which are TEXT ANALYSIS ONLY - NO TOOL CALLS AT ALL.**
    
    STEP 5: Extract dates from PDF text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the dates, save them in memory, and proceed to Step 6.**
    - Search for invoice date keywords: "Datum", "Rechnungsdatum", "Date", "Invoice date", etc.
    - Search for due date keywords: "Fällig am", "Fälligkeitsdatum", "Due date", "Date d'échéance", etc.
    - Extract dates in ISO format (YYYY-MM-DD) if possible, otherwise original format
    - If not found, use the JSON value null (not a tool call - just a value)
    
    STEP 6: Extract invoice number from PDF text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the invoice number, save it in memory, and proceed to Step 7.**
    - Search for invoice number keywords in multiple languages (case-insensitive):
      * German: "Rechnungsnummer", "Rechnungs-Nr.", "Rechnungs-Nummer", "Rechnung Nr.", "Rechnung-Nr."
      * French: "Numéro de facture", "N° facture", "No. facture", "Facture N°", "Facture No."
      * English: "Invoice number", "Invoice No.", "Invoice #", "Invoice Number", "Inv. No."
      * Italian: "Numero fattura", "N° fattura", "Nr. fattura", "Fattura N°"
      * Spanish: "Número de factura", "N° factura", "No. factura", "Factura N°"
      * Dutch: "Factuurnummer", "Factuur nr.", "Factuurnr."
    - Find the keyword in the PDF text
    - Extract the number/value that appears on the same line after the keyword, OR on the line immediately following
    - The invoice number can be alphanumeric (may contain letters, numbers, hyphens, slashes, etc.)
    - Extract the invoice number exactly as it appears (do not modify or format it)
    - If not found, use the JSON value null (not a tool call)
    
    STEP 7: Return final JSON (FINAL ANSWER - NO TOOL CALLS)
    - **CRITICAL: This is your FINAL STEP. You have completed ALL tool calls.**
    - **CRITICAL: Do NOT call any tools. Do NOT use "None" as a tool. "None" is NOT a tool - it is a Python/JSON value.**
    - **CRITICAL: Do NOT try to use any tool. Just provide your Final Answer directly.**
    - Compile all extracted information into the JSON format specified below
    - Provide your Final Answer immediately using the format: "Final Answer: [JSON object]"
    - DO NOT call any tools - just provide the JSON directly
    - **THIS IS YOUR FINAL STEP** - After providing the Final Answer, STOP completely. Do not attempt any more actions.
    
    Business Rules:
    - Vendor name: legal/official company name, NOT buyer/bill-to/ship-to
    - NEVER extract "Sigvaris AG" as vendor name (case-insensitive: "SIGVARIS AG", "Sigvaris AG", "sigvaris ag", etc.)
      * "Sigvaris AG" (in ANY case variation) is the buyer/company requesting this project, NOT the vendor
      * If "Sigvaris AG" is found, SKIP IT and look for a different vendor name
      * If "Sigvaris AG" is the only company name found, return null for vendor_name_extracted
    - Dates: ISO format preferred, null if not found
    - Invoice number: Extract exactly as it appears (alphanumeric, may contain hyphens/slashes), null if not found
    - DO NOT guess or hallucinate any values

  expected_output: >
    Return ONLY a valid JSON object with these exact fields:
    {{
      "vendor_name_extracted": "string or null",
      "vendor_name_matched": "string or null",
      "vendor_number": "string or null",
      "cost_category": "string or null",
      "invoice_date": "YYYY-MM-DD or null",
      "due_date": "YYYY-MM-DD or null",
      "invoice_number": "string or null"
    }}
    
    Do NOT include any explanation, markdown, or code blocks. Return ONLY the JSON object.

  agent: Vendor_Basic_Info_Agent

extract_invoice_details_task:
  description: >
    Extract invoice details and financial information from the invoice PDF.
    
    The PDF file path to process is: {pdf_path}
    
    EXECUTION STEPS (follow in order):
    
    STEP 1: Extract PDF text
    - Call pdf_extractor_fitz tool ONCE with the path: {pdf_path}
    - Save the returned text for all subsequent analysis
    
    STEP 2: Extract orderer name from PDF text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the orderer name, save it in memory, and proceed to Step 3.**
    - STRATEGY 1: Search for order reference keywords ("Bestellreferenz", "Order reference", etc.)
      * If found, extract name from same line or next line after keyword
      * If found, STOP and use this name
    - STRATEGY 2 (only if Strategy 1 fails): Find pattern "Sigvaris AG" → [Orderer Name Line] → [Address Line] → [Postal Code]
      * Search for "Sigvaris AG" (case-insensitive: "SIGVARIS AG", "Sigvaris AG", "sigvaris ag", etc.)
      * The company name may appear as:
        - "Sigvaris AG" on a single line, OR
        - "Sigvaris" on one line followed by "AG" on the next line
      * After finding "Sigvaris AG" (or "Sigvaris" followed by "AG"), check the line IMMEDIATELY AFTER:
        - This line contains the orderer name (the person or department who requested the invoice)
        - The orderer name can be:
          * A person's name with title: "Frau Julia Lehner", "Herrn Partrick Keel", "Frau Sophie Berger"
          * A person's name without title: "Dario Midea"
          * A department name: "IT EAP", "SpediAdmin"
        - Examples of valid orderer names:
          * "Frau Julia Lehner" (person with title)
          * "Dario Midea" (person without title)
          * "IT EAP" (department)
          * "Herrn Partrick Keel" (person with title)
          * "SpediAdmin" (department)
          * "Frau Sophie Berger" (person with title)
      * Verify the pattern structure:
        - Line 1: "Sigvaris AG" (or "Sigvaris" followed by "AG" on next line)
        - Line 2: [Orderer Name] (person name or department name)
        - Line 3: [Address] (street name like "Gröblistrasse 8", "Gröblistr. 8")
        - Line 4: [Postal Code] (numbers like "9014", possibly with "CH-", "St. Gallen", "Schweiz", "Switzerland", "SWITZERLAND")
      * If the pattern matches, extract the orderer name line exactly as it appears
      * If the line after "Sigvaris AG" contains an address pattern (street name, postal code) instead of a name, return null
      * If the pattern does not match, use the JSON value null (not a tool call)
    
    STEP 3: Extract currency from PDF text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the currency, save it in memory, and proceed to Step 4.**
    - Search for currency symbols (€, $, £, ¥, etc.) and currency codes (EUR, USD, CHF, GBP, JPY, etc.) in the invoice text
    - Look especially near amounts, totals, and price information
    - Common currencies to recognize:
      * Euro (EUR, €)
      * Swiss Franc (CHF)
      * US Dollar (USD, $)
      * British Pound (GBP, £)
      * Japanese Yen (JPY, ¥)
    - Extract the primary currency code (e.g., "EUR", "CHF", "USD") or currency name (e.g., "Euro", "Swiss Franc", "Dollar")
    - If multiple currencies appear, extract the primary currency used for invoice amounts and totals
    - If not found or uncertain, use the JSON value null (not a tool call)
    
    STEP 4: Extract invoice description from the text that appears on the invoice PDF File (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the description, save it in memory, and proceed to Step 5.**
    - Analyze the extracted text and line items to understand what the invoice is for
    - Look for line item descriptions, product names, service descriptions, and item details
    - Search for descriptive sections like "Description", "Item Description", "Service Description", "Product", etc.
    - Create a clear, concise summary in natural language that explains the main purpose or content of the invoice
    - The description should interpret the invoice content meaningfully, summarizing the goods or services provided
    - Base the description on actual invoice content (line items, product descriptions, service details)
    - If no meaningful description can be derived from the text and line items, use the JSON value null (not a tool call)
    - DO NOT guess or invent descriptions - base it only on the actual invoice content
    
    STEP 5: Extract Purchase Order (PO) Number from PDF text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the PO number, save it in memory, and proceed to Step 6.**
    - Your objective is to find and extract the Purchase Order (PO) Number from the document
    - PRIORITY 1: Search for high-priority keywords (case-insensitive):
      * "Purchase Order"
      * "PO Number"
      * "Bestellnummer"
      * "Kundenbestellnummer"
      * "Numéro de commande"
    - For each high-priority keyword found, check the value that appears:
      * On the same line after the keyword, OR
      * On the line immediately following the keyword
    - CRITICAL EXCLUSION CHECK: Before extracting any value, verify it is NOT associated with these exclusion keywords:
      * "Rechnungsnummer" (Invoice Number)
      * "Kundennummer" (Customer Number)
      * "Kd.Nr." (Customer Number abbreviation)
      * "Rechnung - Nr." (Invoice Number)
      * "Rechnung - Nr" (Invoice Number)
      * "Numéro de facture" (Invoice Number in French)
      * "Numéro de client" (Customer Number in French)
    - If a value is found near a high-priority keyword AND it is NOT associated with any exclusion keyword, extract it as the PO Number
    - PRIORITY 2 (ONLY if no PO Number found in Priority 1): Search for secondary keywords (case-insensitive):
      * "Order Number"
      * "Auftragsnummer"
      * "Bestellreferenz"
    - For each secondary keyword found, check the value that appears:
      * On the same line after the keyword, OR
      * On the line immediately following the keyword
    - CRITICAL EXCLUSION CHECK: Before extracting any value, verify it is NOT associated with the exclusion keywords listed above
    - If a value is found near a secondary keyword AND it is NOT associated with any exclusion keyword, extract it as the PO Number
    - Extract the PO Number exactly as it appears in the document (do not modify or format it)
    - If no PO Number is found, use the JSON value null (not a tool call)
    - CRITICAL: You MUST ignore all values associated with exclusion keywords. If a number appears near "Rechnungsnummer", "Kundennummer", "Kd.Nr.", "Rechnung - Nr.", "Numéro de facture", or "Numéro de client", DO NOT extract it as the PO Number
    - DO NOT guess or hallucinate any values
    
    STEP 6: Extract Payment ID from PDF text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, extract the Payment ID, save it in memory, and proceed to Step 7.**
    - Your objective is to find and extract the Payment ID from the document
    - Search for the keyword "Referenz" (case-insensitive) in the PDF text
    - The Payment ID is ALWAYS located BELOW (on the line immediately following) the keyword "Referenz"
    - The Payment ID consists of approximately 27 numbers, which may be formatted with spaces (e.g., "12 33210 00202 98290 01271 83506")
    - After finding "Referenz", check the line immediately following it
    - The Payment ID must contain approximately 27 digits (numbers only)
    - After capturing the line, REMOVE ALL SPACES, hyphens, and punctuation from the Payment ID before returning it
    - Convert any letter "O" or "o" to the number "0" (zero). Convert "I", "l", or "L" to the number "1" (one)
    - Return ONLY the cleaned 27-digit numeric string (no spaces, no separators, no extra context)
    - If "Referenz" is found but the following line does not contain a valid Payment ID (approximately 27 numbers), use the JSON value null
    - If "Referenz" is not found, use the JSON value null (not a tool call)
    - DO NOT guess or hallucinate any values
    
    STEP 7: Derive total amounts and VAT from invoice text (ANALYSIS ONLY - NO TOOL CALLS - use text from Step 1)
    - **CRITICAL: This is TEXT ANALYSIS ONLY. Do NOT use the tool call format. Do NOT call any tools. Do NOT use "None" as a tool.**
    - **CRITICAL: Just think internally, analyze the text from Step 1, derive the total amounts, save them in memory, and proceed to Step 8.**
    - Detect all monetary amounts and VAT indicators using multilingual keywords such as "Nettobetrag", "exkl. MWST", "incl. VAT", "TTC", "TVA", "VAT", "MWST Betrag", "Gesamtbetrag", "Betrag inkl.", etc.
    - Determine what each amount represents:
      * Amounts labeled "net", "exkl. MWST", "excl. VAT", "HT", "Nettobetrag", "Total exkl." correspond to totals without VAT
      * Amounts labeled "inkl. MWST", "incl. VAT", "TTC", "Betrag inkl.", "Rechnungsbetrag inkl.", "Gesamtbetrag" correspond to totals with VAT
      * Lines mentioning "MWST", "VAT", "TVA", "Steuersatz", "+ X% MWSt" indicate VAT amounts or percentages—capture both the rate and the numeric VAT amount when present
    - Use ONLY the numbers you read to populate the three output fields:
      * **CRITICAL: Extract the EXACT values as they appear in the invoice text. Do NOT round, modify, or change the extracted numbers. Preserve the exact precision and formatting from the source document.**
      * **EXAMPLES: If invoice shows 366.00, return 366.00 (NOT 366, NOT 366.0, NOT 366.000). If invoice shows 1300.00, return 1300.00 (NOT 1300, NOT 1300.0). Always preserve the exact decimal places and formatting.**
      * If two of the three components (net, VAT amount, gross) are visible, derive the missing one via simple addition/subtraction (e.g., gross = net + VAT amount)
      * If only a gross total exists and no VAT is mentioned anywhere, set total_amount_without_vat = total_amount_with_vat = detected amount (use the EXACT value from text) and total_vat_amount = 0.0 (or the exact value if explicitly shown)
      * **CRITICAL: When values are the same in the invoice (e.g., both total_amount_without_vat and total_amount_with_vat are 366.00), return them EXACTLY as they appear - same value, same precision, same formatting. Do NOT modify or recalculate. If invoice shows 366.00 for both, return 366.00 for both. If invoice shows 1300.00, return 1300.00 exactly as shown.**
      * Always align the values with the currency identified in Step 3, but preserve the exact numeric values from the invoice text
      * When multiple candidates are found, prefer the final summary block over intermediate subtotals
    - If you cannot confidently identify or derive a value, return null rather than guessing
    - Save the three final values (total_amount_without_vat, total_amount_with_vat, total_vat_amount) and proceed to Step 8 (Final Answer).
    
    STEP 8: Return final JSON (FINAL ANSWER - NO TOOL CALLS)
    - **CRITICAL: This is your FINAL STEP. You have completed ALL tool calls.**
    - **CRITICAL: Do NOT call any tools. Do NOT use "None" as a tool. "None" is NOT a tool - it is a Python/JSON value.**
    - **CRITICAL: Do NOT try to use any tool. Just provide your Final Answer directly.**
    - Compile all extracted information into the JSON format specified below
    - Provide your Final Answer immediately using the format: "Final Answer: [JSON object]"
    - DO NOT call any tools - just provide the JSON directly
    - **THIS IS YOUR FINAL STEP** - After providing the Final Answer, STOP completely. Do not attempt any more actions.
    
    Business Rules:
    - Orderer name: Extract exactly as it appears, null if pattern not found
    - Currency: Extract currency code (e.g., "EUR", "CHF", "USD") or currency name (e.g., "Euro", "Swiss Franc", "Dollar"), null if not found
    - Invoice description: Clear, concise summary of invoice purpose based on line items and extracted text, null if no meaningful description can be derived
    - PO Number: Extract exactly as it appears (may be alphanumeric, may contain hyphens/slashes/special characters), null if not found
    - Payment ID: Extract the value below "Referenz", then normalize it to a digits-only string (remove spaces, replace O/o with 0, replace I/l/L with 1). Return only the cleaned numeric string, null if not found
    - Total Amount without VAT: Extract directly from text (net/excl. VAT) using the EXACT value as it appears. Do NOT round or modify. Examples: 366.00 stays 366.00, 1300.00 stays 1300.00. If unavailable, derive only when two reliable values exist; otherwise return null
    - Total Amount with VAT: Extract directly from text (gross/incl. VAT) using the EXACT value as it appears. Do NOT round or modify. Examples: 366.00 stays 366.00, 1300.00 stays 1300.00. If unavailable, derive only when two reliable values exist; otherwise return null
    - Total VAT Amount: Extract lines labeled VAT/MWST using the EXACT value as it appears, or compute as gross − net when both are confirmed; otherwise return null. Do NOT round or modify extracted values. Examples: 0.0 stays 0.0, 0.00 stays 0.00.
    - DO NOT guess or hallucinate any values
    - DO NOT invent VAT rates or perform speculative calculations—base everything on explicit invoice data

  expected_output: >
    Return ONLY a valid JSON object with these exact fields:
    {{
      "orderer_name": "string or null",
      "currency": "string or null",
      "invoice_description": "string or null",
      "po_number": "string or null",
      "payment_id": "string or null",
      "total_amount_without_vat": "float or null (format with 2 decimal places, e.g., 1300.00, 366.00)",
      "total_amount_with_vat": "float or null (format with 2 decimal places, e.g., 1300.00, 366.00)",
      "total_vat_amount": "float or null (format with 2 decimal places, e.g., 0.00)"
    }}
    
    **CRITICAL: Amount fields must be formatted with exactly 2 decimal places. Examples: 1300.00 (NOT 1300.0 or 1300), 366.00 (NOT 366.0 or 366), 0.00 (NOT 0.0 or 0).**
    
    Do NOT include any explanation, markdown, or code blocks. Return ONLY the JSON object.

  agent: Invoice_Details_Agent

merge_results_task:
  description: >
    Merge the outputs from Vendor_Basic_Info_Agent and Invoice_Details_Agent into a single, complete JSON object.
    
    **CRITICAL: You have access to the outputs from the two previous tasks through the context.**
    The previous tasks have already been executed and their outputs are available to you.
    
    **CRITICAL: The outputs from previous tasks are available in the context. You MUST access them directly from the context.**
    
    You will receive two JSON objects from the previous tasks:
    1. From extract_vendor_basic_info_task: Contains 7 fields (vendor_name_extracted, vendor_name_matched, 
       vendor_number, cost_category, invoice_date, due_date, invoice_number)
    2. From extract_invoice_details_task: Contains 8 fields (orderer_name, currency, invoice_description, 
       po_number, payment_id, total_amount_without_vat, total_amount_with_vat, total_vat_amount)
    
    Your task is to combine these two JSON objects into ONE single JSON object containing ALL 15 fields in the correct order:
    1. vendor_name_extracted
    2. vendor_name_matched
    3. vendor_number
    4. cost_category
    5. invoice_date
    6. due_date
    7. invoice_number
    8. orderer_name
    9. currency
    10. invoice_description
    11. po_number
    12. payment_id
    13. total_amount_without_vat
    14. total_amount_with_vat
    15. total_vat_amount
    
    CRITICAL RULES:
    - You MUST preserve all values exactly as they appear in the input JSON objects
    - You MUST NOT modify, calculate, or change any values
    - You MUST NOT add any fields that are not in the input JSON objects
    - You MUST NOT remove any fields from the input JSON objects
    - You MUST ensure all 15 fields are present in the final JSON object
    - If a field is null in the input, it must remain null in the output
    - You MUST return ONLY a valid JSON object - no explanations, no markdown, no code blocks
    
    EXECUTION STEPS:
    
    STEP 1: Read the output from extract_vendor_basic_info_task
    - **CRITICAL: Access the output from the first task in the context. The context contains the outputs from previous tasks.**
    - **CRITICAL: Look for the output from extract_vendor_basic_info_task in the context provided to you.**
    - **CRITICAL: The output should be a JSON object with 7 fields: vendor_name_extracted, vendor_name_matched, vendor_number, cost_category, invoice_date, due_date, invoice_number**
    - Extract all 7 fields from this JSON object
    - If the output is in a different format, parse it to extract the JSON object
    - **CRITICAL: If you cannot find the output in the context, look for any JSON output that contains these fields: vendor_name_extracted, vendor_name_matched, vendor_number, cost_category, invoice_date, due_date, invoice_number**
    
    STEP 2: Read the output from extract_invoice_details_task
    - **CRITICAL: Access the output from the second task in the context. The context contains the outputs from previous tasks.**
    - **CRITICAL: Look for the output from extract_invoice_details_task in the context provided to you.**
    - **CRITICAL: The output should be a JSON object with 8 fields: orderer_name, currency, invoice_description, po_number, payment_id, total_amount_without_vat, total_amount_with_vat, total_vat_amount**
    - Extract all 8 fields from this JSON object
    - If the output is in a different format, parse it to extract the JSON object
    - **CRITICAL: If you cannot find the output in the context, look for any JSON output that contains these fields: orderer_name, currency, invoice_description, po_number, payment_id, total_amount_without_vat, total_amount_with_vat, total_vat_amount**
    
    STEP 3: Combine both JSON objects
    - Create a new JSON object containing all 15 fields in the correct order
    - Preserve all values exactly as they appear in the input JSON objects
    - Do NOT modify, calculate, or change any values
    - Do NOT add any fields that are not in the input JSON objects
    - Do NOT remove any fields from the input JSON objects
    - Ensure all 15 fields are present in the final JSON object
    - If a field is null in the input, it must remain null in the output
    
    STEP 4: Return final JSON (FINAL ANSWER)
    - **CRITICAL: This is your FINAL STEP.**
    - **CRITICAL: Do NOT call any tools. Do NOT use "None" as a tool. "None" is NOT a tool - it is a Python/JSON value.**
    - **CRITICAL: Do NOT try to use any tool. Just provide your Final Answer directly.**
    - Provide your Final Answer immediately using the format: "Final Answer: [JSON object]"
    - DO NOT call any tools - just provide the JSON directly
    - **THIS IS YOUR FINAL STEP** - After providing the Final Answer, STOP completely. Do not attempt any more actions.

  expected_output: >
    Return ONLY a valid JSON object with these exact fields in this exact order:
    {{
      "vendor_name_extracted": "string or null",
      "vendor_name_matched": "string or null",
      "vendor_number": "string or null",
      "cost_category": "string or null",
      "invoice_date": "YYYY-MM-DD or null",
      "due_date": "YYYY-MM-DD or null",
      "invoice_number": "string or null",
      "orderer_name": "string or null",
      "currency": "string or null",
      "invoice_description": "string or null",
      "po_number": "string or null",
      "payment_id": "string or null",
      "total_amount_without_vat": "float or null (format with 2 decimal places, e.g., 1300.00, 366.00)",
      "total_amount_with_vat": "float or null (format with 2 decimal places, e.g., 1300.00, 366.00)",
      "total_vat_amount": "float or null (format with 2 decimal places, e.g., 0.00)"
    }}
    
    **CRITICAL: Amount fields must be formatted with exactly 2 decimal places. Examples: 1300.00 (NOT 1300.0 or 1300), 366.00 (NOT 366.0 or 366), 0.00 (NOT 0.0 or 0). Preserve values exactly as they appear in the input JSON objects.**
    
    Do NOT include any explanation, markdown, or code blocks. Return ONLY the JSON object.

  agent: Result_Merger_Agent
